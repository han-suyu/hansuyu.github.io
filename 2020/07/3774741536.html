<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>YOLO v1学习总结 | 愿风载尘</title><meta name="description" content="原论文：《You Only Look Once Unified，Real-Time Object Detection》                   原论文：https:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;1506.02640 下载好的：https:&#x2F;&#x2F;wwa.lanzous.com&#x2F;iF8YYef3cfe        &amp;nbsp; &amp;nbsp;  写在前面 在学习"><meta name="keywords" content="目标检测,YOLO"><meta name="author" content="Seven"><meta name="copyright" content="Seven"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://hansuyu.com/2020/07/3774741536.html"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="u9AaJlYHNmU4dpUtiWPMA9_vQRU4zjcERKUymU8aEao"/><meta name="baidu-site-verification" content="m7BzC4y6nU"/><meta property="og:type" content="article"><meta property="og:title" content="YOLO v1学习总结"><meta property="og:url" content="http://hansuyu.com/2020/07/3774741536.html"><meta property="og:site_name" content="愿风载尘"><meta property="og:description" content="原论文：《You Only Look Once Unified，Real-Time Object Detection》                   原论文：https:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;1506.02640 下载好的：https:&#x2F;&#x2F;wwa.lanzous.com&#x2F;iF8YYef3cfe        &amp;nbsp; &amp;nbsp;  写在前面 在学习"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/han-suyu/cover/40.jpg"><meta property="article:published_time" content="2020-07-07T13:43:19.000Z"><meta property="article:modified_time" content="2020-07-13T03:25:46.317Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="prev" title="YOLO v2学习总结" href="http://hansuyu.com/2020/07/1563922670.html"><link rel="next" title="基于DenseNet模型实现MNIST手写体数据集的训练" href="http://hansuyu.com/2020/07/1919729354.html"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: Seven","link":"链接: ","source":"来源: 愿风载尘","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"top-center"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/flink.min.css"><link rel="stylesheet" href="/css/my.css"><link rel="stylesheet" href="http://at.alicdn.com/t/font_1927020_azxlhjmymca.css"><link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css"><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">158</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">20</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-calendar"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tag"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/photos/"><i class="fa-fw fa fa-camera"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-edit"></i><span> 心情</span></a></div><div class="menus_item"><a class="site-page" href="/toolbox/"><i class="fa-fw fa fa-leaf"></i><span> 小工具</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-institution"></i><span> 实验室</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/color/"><i class="fa-fw fa fa-magic"></i><span> RGB颜色</span></a></li><li><a class="site-page" href="/hexconvert/"><i class="fa-fw fa fa-calculator"></i><span> 进制转换</span></a></li><li><a class="site-page" href="/diff/"><i class="fa-fw fa fa-clone"></i><span> 文本对比</span></a></li><li><a class="site-page" href="/map/"><i class="fa-fw fa fa-globe"></i><span> 地球图层</span></a></li><li><a class="site-page" href="/dog/"><i class="fa-fw fa fa-heartbeat"></i><span> 舔狗日记</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-game"></i><span> 小游戏</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/Sudoku/"><span> 数独</span></a></li><li><a class="site-page" href="/jumper/"><span> 跳一跳</span></a></li><li><a class="site-page" href="/puzzleNumber/"><span> 数字拼图</span></a></li><li><a class="site-page" href="/referrence/"><span> referrence</span></a></li></ul></div></div></div></div><i class="fas fa-arrow-right" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#写在前面"><span class="toc-text"> 写在前面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-从目标检测说起"><span class="toc-text"> 1. 从目标检测说起</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-主流目标检测算法"><span class="toc-text"> 2. 主流目标检测算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-yolo的引入"><span class="toc-text"> 3. YOLO的引入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一-核心思想"><span class="toc-text"> 一. 核心思想</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-两个bounding-box的位置-两组xywh值"><span class="toc-text"> 1.1 两个bounding box的位置 (两组xywh值)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-两个bbox的置信度confidence"><span class="toc-text"> 1.2  两个bbox的置信度confidence</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-十个对象分类的概率"><span class="toc-text"> 1.3 十个对象分类的概率</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-网络结构"><span class="toc-text"> 二. 网络结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-训练"><span class="toc-text"> 三. 训练</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-性能"><span class="toc-text"> 四. 性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-优点"><span class="toc-text"> 4.1 优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-缺点"><span class="toc-text"> 4.2 缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五-其他"><span class="toc-text"> 五. 其他</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#51-yolo的bounding-box并不是faster-rcnn的anchor"><span class="toc-text"> 5.1 YOLO的bounding box并不是Faster RCNN的Anchor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#52-预测inference"><span class="toc-text"> 5.2 预测（inference）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#53-nms非极大值抑制"><span class="toc-text"> 5.3 NMS（非极大值抑制）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六-源程序"><span class="toc-text"> 六. 源程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-基于图片的目标检测"><span class="toc-text"> 6.1 基于图片的目标检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-基于视频的目标检测"><span class="toc-text"> 6.2 基于视频的目标检测</span></a></li></ol></li></ol></div></div></div><div class="code-close" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/han-suyu/cover/40.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">愿风载尘</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-calendar"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tag"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/photos/"><i class="fa-fw fa fa-camera"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-edit"></i><span> 心情</span></a></div><div class="menus_item"><a class="site-page" href="/toolbox/"><i class="fa-fw fa fa-leaf"></i><span> 小工具</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-institution"></i><span> 实验室</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/color/"><i class="fa-fw fa fa-magic"></i><span> RGB颜色</span></a></li><li><a class="site-page" href="/hexconvert/"><i class="fa-fw fa fa-calculator"></i><span> 进制转换</span></a></li><li><a class="site-page" href="/diff/"><i class="fa-fw fa fa-clone"></i><span> 文本对比</span></a></li><li><a class="site-page" href="/map/"><i class="fa-fw fa fa-globe"></i><span> 地球图层</span></a></li><li><a class="site-page" href="/dog/"><i class="fa-fw fa fa-heartbeat"></i><span> 舔狗日记</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-game"></i><span> 小游戏</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/Sudoku/"><span> 数独</span></a></li><li><a class="site-page" href="/jumper/"><span> 跳一跳</span></a></li><li><a class="site-page" href="/puzzleNumber/"><span> 数字拼图</span></a></li><li><a class="site-page" href="/referrence/"><span> referrence</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">YOLO v1学习总结</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-07 21:43:19"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2020-07-07</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-13 11:25:46"><i class="fas fa-history fa-fw"></i> 更新于 2020-07-13</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/Computer-Version/">Computer Version</a><i class="fas fa-angle-right post-meta__separator"></i><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/Computer-Version/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/">目标检测</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta__icon"></i><span>字数总计:</span><span class="word-count">11.4k</span><span class="post-meta__separator">|</span><i class="far fa-clock fa-fw post-meta__icon"></i><span>阅读时长: 48 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="far fa-comments fa-fw post-meta__icon"></i><span>评论数:</span><a href="/2020/07/3774741536.html#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/07/3774741536.html" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><div class="spoiler collapsed">
    <div class="spoiler-title">
        原论文：《You Only Look Once Unified，Real-Time Object Detection》
    </div>
    <div class="spoiler-content">
        <p><strong>原论文</strong>：<a href="https://arxiv.org/abs/1506.02640" target="_blank" rel="noopener external nofollow noreferrer">https://arxiv.org/abs/1506.02640</a></p>
<p><strong>下载好的</strong>：<a href="https://wwa.lanzous.com/iF8YYef3cfe" target="_blank" rel="noopener external nofollow noreferrer">https://wwa.lanzous.com/iF8YYef3cfe</a></p>

    </div>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h2>
<p>在学习YOLO的最开始阶段，我钻上了牛角尖。我感觉网络上有些文章讲得有点直接，上来就聊原理说架构，作为小白我理解起来有点吃力。比如：</p>
<div class="note warning">
            <p>如果image中某个object box的中心落在某个grid cell内部，那么这个cell就对检测该object负责。</p>
          </div>
<p>在检测结果还没出来之前，这个cell怎么知道某个object box的中心落在它身上？它是怎么感知到这个object的？不应该是先负责然后才能知道object box的中心落在它身上吗？又怎么个负责法？</p>
<p>&nbsp;</p>
<p>兜兜转转一段时间，我发现了一篇浅显易懂的文章【<a href="https://zhuanlan.zhihu.com/p/37850811" target="_blank" rel="noopener external nofollow noreferrer">你真的读懂yolo了吗？</a> - stone的文章 - 知乎】</p>
<p>感觉这篇文章直击我的“痛点”，回答了我的疑问，让我有种柳暗花明的顿悟感。（十分敬佩&amp;感谢博主）</p>
<p>&nbsp;</p>
<p>这篇文章的作者也指出：</p>
<blockquote>
<p>原论文是按照测试阶段进行解读的，不容易让人理解，网上关于yolo的文章又基本都是照着原文翻译，很多背后的原理没有讲清楚。其实，知道训练阶段的意义更重要，因为训练阶段你告诉网络去预测什么，然后测试阶段才能按照你训练阶段教它的去做，如果你只知道测试阶段网络输出的意义，你就很可能会问：<strong>凭什么物体的中心落在这个cell它就负责预测这个物体？</strong></p>
</blockquote>
<p>&nbsp;</p>
<p>另外，有一个网站叫<a href="https://docs.google.com/presentation/d/1aeRvtKG21KHdD5lg6Hgyhx5rPq_ZOsGjG5rJ1HP7BbA/pub?start=false&amp;loop=false&amp;delayms=3000&amp;slide=id.p" target="_blank" rel="noopener external nofollow noreferrer">deepsystems.io</a> 。里面有YOLO算法的讲解ppt，总共73页，步骤清晰、图文并茂，非常有利于理解，墙裂推荐！！！</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="1-从目标检测说起"><a class="markdownIt-Anchor" href="#1-从目标检测说起"></a> 1. 从目标检测说起</h3>
<p>目标检测就是要找出图片中物体，用边框框出来，如图1中的红色部分，这个边框就叫做bounding box（边界框）。同时判定框内物体的类别，即判断出图中这个物体为“猫”。</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/UutAqs.jpg" alt="图1：猫" style="zoom: 40%;">
<p>比如图1中的这只猫，我们规定bounding box左上角那一点的坐标为(x,y)，bounding box边框的宽为w，高为h。</p>
<p>通过这种办法我们就能在一张图片里唯一的确定一个bounding box的位置，这就相当于目标检测成功。</p>
<p>&nbsp;</p>
<p>那么问题来了，怎么去精准地框定图片中的这只猫呢？一个很自然的想法就是，我把图片输入到训练好的模型，让网络学习输出bounding box的xywh四个值以及图片的类别。这么做貌似是可以的，但考虑这么一种情况：如果图片上除了一只猫之外还有一只狗（如图2），甚至更多的物体，我们都想把它们框出来，那么这时候网络就不仅仅要输出猫的预测，还有输出其他物体的预测。</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/11/U1Zrh4.jpg" alt="图2：猫和人" style="zoom:80%;">
<p>这个时候我们发现，模型的输出的维度是没办法固定的，图片中存在的物体越多，模型输出的维度就越大。所以这种思路行不通。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="2-主流目标检测算法"><a class="markdownIt-Anchor" href="#2-主流目标检测算法"></a> 2. 主流目标检测算法</h3>
<p>传统目标检测系统采用deformable parts models (DPM)方法，通过<code>HOG特征提取+SVM分类器+滑动窗</code>来实现识别。近期的R-CNN类方法采用region proposal methods，先产生候选区域然后再使用CNN识别候选区中的对象，虽然准确率比较高，但是即使是发展到Faster R-CNN，检测一张图片如下图所示也要7fps(原文为5fps)，图3是YOLO的网络结构示意图的检测性能对比：</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/UutVZn.png" alt="图3：常见目标检测算法性能对比" style="zoom:24%;">
<p>YOLO创造性的将候选区和对象识别这两个阶段合二为一，看一眼图片（不用看两眼哦）就能知道有哪些对象以及它们的位置。解决了当时基于深度学习的检测中的痛点——速度问题，可以用于实时系统。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="3-yolo的引入"><a class="markdownIt-Anchor" href="#3-yolo的引入"></a> 3. YOLO的引入</h3>
<p>由上可得：模型输出的维度最好是固定的。基于此，我们可以设计一个固定维度大小的输出，并且输出的维度足够大，以至于可以囊括图像中所有的物体。yolo就是这么做的。</p>
<p>yolo固定维度的办法是把图片划分为 7x7=49 个网格cell（最多表示出49个对象），每个网格允许预测出2个边框，总共 49*2=98 个bounding box。可以理解为98个候选区，它们很粗略的覆盖了图片的整个区域。另外，还会相应的输出两个类别信息。如图4所示。</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/UuteI0.jpg" alt="图4：网格划分" style="zoom: 40%;">
<div class="note info">
            <p>实际上，YOLO并没有真正去掉候选区，而是采用了预定义的候选区（准确点说应该是预测区，因为并不是Faster RCNN所采用的Anchor）</p>
          </div>
<p>但问题的关键是，我们怎么知道cell需要预测图片中的哪个物体呢？这个其实取决于你怎么去设置模型的训练目标，说白一点就是，你要教它去预测哪个物体。具体来说，yolo是这么做的：</p>
<p>将输入图像划分之后，每个cell负责检测落入该格子的物体。若某个物体的中心位置的坐标落入到某个格子，那么这个格子就负责检测出这个物体。如图5所示，图中物体狗的中心点（红色原点）落入第5行、第2列的格子内，所以这个格子负责预测图像中的物体狗。</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/UutbF0.png" alt="图5：目标检测实例" style="zoom:80%;">
<p>这么说可能不太容易理解，下面进行更具体的介绍。</p>
<p><strong>实际上，“物体落在哪个cell，哪个cell就负责预测这个物体” 要分两个阶段来看，包括训练和测试。</strong></p>
<ol>
<li>训练阶段。在训练阶段，如果物体中心落在这个cell，那么就给这个cell打上这个物体的label（包括xywh和类别），也就是说我们是通过这种方式来设置训练的label的。换言之，我们在训练阶段，就教会cell要预测图像中的哪个物体。</li>
<li>测试阶段。因为你在训练阶段已经教会了cell去预测中心落在该cell中的物体，那么cell自然也会这么做。</li>
</ol>
<p>&nbsp;</p>
<p>图6就是YOLO的检测系统示意图。在test阶段，经过单个CNN网络前向计算来预测多个bounding boxes和类别概率，再经过非极大值抑制，就可以给出检测结果。<br>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/UutTwn.png" alt="图6：YOLO V1检测系统示意图"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="一-核心思想"><a class="markdownIt-Anchor" href="#一-核心思想"></a> 一. 核心思想</h2>
<p>网格划分：将输入image划分为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mo>×</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">S \times S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 个grid cell，如果image中某个object box的中心落在某个grid cell内部，那么这个cell就对该object负责。</p>
<p>同时，每个grid cell同时预测B个<strong>bounding box的位置 (x, y, w, h)<strong>和一个</strong>置信度confidence</strong> 。</p>
<p>每个grid cell还要预测一个<strong>分类概率</strong>，记为 C 个类。</p>
<p>总的来说， <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mo>×</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">S \times S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 个网格，输出就是 一个S * S * (5B+C) 的tensor。在PASCAL VOC进行测试时，使用S=7, B=2。由于共有20类，故C=20。因此 输出向量长度 = 20 + 2 * (4+1) = 30。整个输出的tensor就是 7x7x30。</p>
<p>&nbsp;</p>
<p>即：<code>30维向量</code> =  <code>2个bounding box * 4个坐标</code> + <code>2个bounding box的置信度</code> +  <code>20个对象的概率</code></p>
<p>&nbsp;</p>
<p>下面分别对这三类输出信息进行解读：</p>
<h3 id="11-两个bounding-box的位置-两组xywh值"><a class="markdownIt-Anchor" href="#11-两个bounding-box的位置-两组xywh值"></a> 1.1 两个bounding box的位置 (两组xywh值)</h3>
<p>之前就已经叙述过了这四个值的含义。这里主要讲它的归一化操作。xy表示bounding box的中心相对于cell左上角坐标偏移，宽高则是相对于整张图片的宽高进行归一化的。偏移的计算方法如图7所示。</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/Uutkrj.png" alt="图7：偏移计算方法" style="zoom:75%;">
<p>经过这种处理后，xywh都被归一化了，值都是在0-1之间。否则可能导致各个输出维度的取值范围差别很大，进而导致训练的时候，网络更关注数值大的维度，最终导致区别对待。因为数值大的维度，相应的loss会比较大，为了让这个loss减小，网络就会尽可能的学习这个维度。</p>
<p>&nbsp;</p>
<h3 id="12-两个bbox的置信度confidence"><a class="markdownIt-Anchor" href="#12-两个bbox的置信度confidence"></a> 1.2  两个bbox的置信度confidence</h3>
<p>confidence表示cell预测的bounding box包含一个物体的置信度有多高并且该bounding box预测准确度有多大。也就是说这个置信度并不只是该bounding box是待检测目标的概率，而是该bounding box是待检测目标的概率乘上该bounding box和真实位置的IOU的积。如下式所示：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">)</mo><mo>∗</mo><msubsup><mrow><mi>I</mi><mi>O</mi><mi>U</mi></mrow><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">{confidence} = P(Object)* {IOU}_{pred}^{truth}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.3054459999999999em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9223379999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">d</span></span></span></span><span style="top:-3.1362300000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mrow><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P({Object})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span></span><span class="mclose">)</span></span></span></span> 是bounding box内存在对象的概率，非0即1。区别于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>C</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mrow><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P({C}_i|{Object})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span></span><span class="mclose">)</span></span></span></span>  。前者并不管是哪个对象，它体现的是 有或没有 对象的概率；而后者意思是假设已经有一个对象在网格中了，这个对象具体是哪一个。</p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>I</mi><mi>O</mi><msubsup><mi>U</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">IOU^{truth}_{pred}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2683239999999998em;vertical-align:-0.4192159999999999em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.4168920000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">d</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> 是输出的两个bounding box 分别与对象真实bounding box 的IOU（Intersection over Union，交并比）。然后看2个bounding box的IOU，哪个比较大（更接近对象实际的bounding box），就由哪个bounding box来负责预测该对象是否存在，即该bounding box的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">P(Object)=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> ，同时对象真实bounding box的位置也就填入该bounding box。另一个不负责预测的bounding box的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">P(Object)=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>  。总的来说就是，与对象实际bounding box最接近的那个bounding box，其<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>=</mo><mi>I</mi><mi>O</mi><msubsup><mi>U</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">confidence =  IOU_{pred}^{truth}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2683239999999998em;vertical-align:-0.4192159999999999em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.4168920000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">d</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> ，该网格的其它bounding box的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">confidence=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 。</p>
<p>&nbsp;</p>
<p>简单解释一下IOU。下图8来自Andrew Ng的深度学习课程，IOU=交集部分面积/并集部分面积，2个box完全重合时IOU=1，不相交时IOU=0。</p>
<p><img src= "/img/loading.gif" data-src="https://image-static.segmentfault.com/260/453/2604535154-5bc4906a127a3_articlex" alt="图8：IOU"></p>
</li>
</ul>
<p>&nbsp;</p>
<div class="note info">
            <p>还要说明的是，虽然有时说"预测"的bounding box，但这个IOU是在训练阶段计算的。等到了测试阶段（Inference），这时并不知道真实对象在哪里，只能完全依赖于网络的输出，这时已经不需要（也无法）计算IOU了。</p>
          </div>
<p>&nbsp;</p>
<p>综合来说，一个bounding box的置信度Confidence意味着它是否包含对象且位置准确的程度。<strong>置信度高表示这里存在一个对象且位置比较准确，置信度低表示可能没有对象 或者 即便有对象也存在较大的位置偏差。</strong></p>
<p>&nbsp;</p>
<h3 id="13-十个对象分类的概率"><a class="markdownIt-Anchor" href="#13-十个对象分类的概率"></a> 1.3 十个对象分类的概率</h3>
<p>因为YOLO支持识别20种不同的对象（人、鸟、猫、汽车、椅子等），所以这里有20个值表示该网格位置存在任一种对象的概率。可以记为  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><msub><mi>s</mi><mn>1</mn></msub><mi mathvariant="normal">∣</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(Class_1|Object)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span> ，  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><msub><mi>s</mi><mn>2</mn></msub><mi mathvariant="normal">∣</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(Class_2|Object)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span> ，…， <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><msub><mi>s</mi><mn>20</mn></msub><mi mathvariant="normal">∣</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(Class_{20}|Object)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span> 。这个怎么理解？也可以分两个阶段来看。</p>
<ol>
<li>对于训练阶段，也就是打label阶段，怎么打label呢？对于一个cell，如果物体的中心落在了这个cell，那么我们给它打上这个物体的类别label，并设置概率为1。换句话说，这个概率是存在一个条件的，这个条件就是cell存在物体。</li>
<li>对于测试阶段来说，网络直接输出 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mtext>Class</mtext><mi mathvariant="normal">∣</mi><mtext>Object</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\text{Class}|\text{Object})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord text"><span class="mord">Class</span></span><span class="mord">∣</span><span class="mord text"><span class="mord">Object</span></span><span class="mclose">)</span></span></span></span> ，就已经可以代表有物体存在的条件下类别概率。但是在测试阶段，作者还把这个概率乘上了confidence。</li>
</ol>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><mo>×</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mtext>Object</mtext><mo stretchy="false">)</mo><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow><mi>i</mi></msub><mo stretchy="false">)</mo><mo>×</mo><msubsup><mrow><mi>I</mi><mi>O</mi><mi>U</mi></mrow><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">{confidence}\times P({Class}_i|\text{Object}) = P({Class}_i)\times {IOU}_{pred}^{truth}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord text"><span class="mord">Object</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.3054459999999999em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9223379999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">d</span></span></span></span><span style="top:-3.1362300000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>​		也就是说我们预测的条件概率还要乘以confidence。为什么这么做呢？举个例子，对于某个cell来说，在预测		阶段，即使这个cell不存在物体（即confidence的值为0），而输出的条件概率<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi><mrow><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow><mo stretchy="false">)</mo><mo>=</mo><mn>0.9</mn></mrow><annotation encoding="application/x-tex">P({Class}|{Object})=0.9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span></span></span></span> ，但		将confidence和  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi><mrow><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P({Class}|{Object})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span></span><span class="mclose">)</span></span></span></span> 乘起来就变成0了。这个是很合理的，因为你得确保cell中有物体，计算		类别概率才有意义。</p>
<p>​       &nbsp;</p>
<p>​        在test的<a href="https://img-blog.csdn.net/20170420214347813?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHJzc3R1ZHk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" target="_blank" rel="noopener external nofollow noreferrer">非极大值抑制</a>阶段，对于每个bounding box，我们应该按照上式衡量该框是否应该予以保留。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="二-网络结构"><a class="markdownIt-Anchor" href="#二-网络结构"></a> 二. 网络结构</h2>
<p>YOLO网络借鉴了GoogLeNet分类网络结构，但是没有采取inception的结构，而是使用1x1卷积层 + 3x3卷积层替代。共有24个卷积层用来提取图像特征，后面接2个全连接层用来预测图像位置和类别概率值，如图9所示。</p>
<p><img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/Uutoes.png" alt="图9：YOLO的网络结构示意图"></p>
<div class="note default">
            <p>YOLO的最后一层采用线性激活函数，其它层都是Leaky ReLU。训练中采用了drop out和数据增强（data augmentation）来防止过拟合。更多细节请参考原论文。</p>
          </div>
<p>从图中可以看到，yolo网络的输出的网格是7x7大小的，另外，输出的channel数目为30。一个cell内，前20个元素是类别概率值，然后2个元素是边界框confidence，最后8个元素是边界框的 (x, y,w,h) 。如图10所示。</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/10/UutFMQ.jpg" alt="图10：yolo网络输出结构" style="zoom: 67%;">
<p>也就是说，每个cell有两个predictor，每个predictor分别预测一个bounding box的xywh和相应的confidence。但分类部分的预测却是共享的。正因为这个，同个cell是没办法预测多个目标的。</p>
<p>现在考虑两个问题:</p>
<ol>
<li>
<p>假设类别预测不是共享的，cell中两个predictor都有各自的类别预测，这样能否在一个cell中预测两个目标？</p>
</li>
<li>
<p>为什么要预测两个bounding box？</p>
<p>&nbsp;</p>
</li>
</ol>
<p>对于第一个问题，答案是否定的。如果一个cell要预测两个目标，那么这两个predictor要怎么分工预测这两个目标？谁负责谁？不知道，所以没办法预测。而像faster rcnn这类算法，可以根据anchor与ground truth的IOU大小来安排anchor负责预测哪个物体，所以后来yolo2也采用了anchor思想，同个cell才能预测多个目标。</p>
<p>对于第二个问题，既然我们一个cell只能预测一个目标，为什么还要预测两个bounding box（或者更多）？这个还是要从训练阶段怎么给两个predictor安排训练目标来说。在训练的时候会在线地计算每个predictor预测的bounding box和ground truth的IOU，计算出来的IOU大的那个predictor，就会负责预测这个物体，另外一个则不预测。这么做有什么好处？我的理解是，这样做的话，实际上有两个predictor来一起进行预测，然后网络会在线选择预测得好的那个predictor（也就是IOU大）来进行预测。通俗一点说，就是我找一堆人来并行地干一件事，然后我选干的最好的那个。</p>
<p>&nbsp;</p>
<div class="note default">
            <p>YOLO论文中，作者还给出一个更轻快的检测网络fast YOLO，它只有9个卷积层和2个全连接层，其他部分完全一样。使用titan x GPU，fast YOLO可以达到155fps的检测速度，但是mAP值也从YOLO的63.4%降到了52.7%，但却仍然远高于以往的实时物体检测方法（DPM）的mAP值。</p>
          </div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="三-训练"><a class="markdownIt-Anchor" href="#三-训练"></a> 三. 训练</h2>
<p>损失就是网络实际输出值与样本标签值之间的偏差。</p>
<p>&nbsp;</p>
<p>YOLO给出的损失函数如图11所示。</p>
<img src= "/img/loading.gif" data-src="https://image-static.segmentfault.com/160/476/1604765359-5bc490697d2bd" alt="图11：损失函数" style="zoom:60%;">
<p>公式中</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mn>1</mn><mi>i</mi><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">1^{obj}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2438799999999999em;vertical-align:-0.276864em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9670159999999999em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.276864em;"><span></span></span></span></span></span></span></span></span></span> 意思是网格i中存在对象。</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mn>1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">1^{obj}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.379988em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9670159999999999em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span></span></span></span> 意思是网格i的第j个bounding box中存在对象。</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mn>1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">1^{no obj}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.379988em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9670159999999999em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span></span></span></span> 意思是网格i的第j个bounding box中不存在对象。</li>
</ul>
<p>总的来说，就是用网络输出与样本标签的各项内容的误差平方和作为一个样本的整体误差。<br>
损失函数中的几个项是与输出的30维向量中的内容相对应的。</p>
<p>&nbsp;</p>
<p><strong>① 对象分类的误差</strong><br>
公式第5行，注意 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mn>1</mn><mi>i</mi><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">1^{obj}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2438799999999999em;vertical-align:-0.276864em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9670159999999999em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.276864em;"><span></span></span></span></span></span></span></span></span></span> 意味着存在对象的网格才计入误差。</p>
<p><strong>② bounding box的位置误差</strong><br>
公式第1行和第2行。</p>
<ul>
<li>
<p>都带有 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mn>1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">1^{obj}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.379988em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9670159999999999em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span></span></span></span> 意味着只有"负责"（IOU比较大）预测的那个bounding box的数据才会计入误差。</p>
</li>
<li>
<p>第2行宽度和高度先取了平方根，因为如果直接取差值的话，大的对象对差值的敏感度较低，小的对象对差值的敏感度较高，所以取平方根可以降低这种敏感度的差异，使得较大的对象和较小的对象在尺寸误差上有相似的权重。</p>
</li>
<li>
<p>乘以 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\lambda_{coord}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 调节bounding box位置误差的权重（相对分类误差和置信度误差）。YOLO设置 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">\lambda_{coord}=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span> ，即调高位置误差的权重。</p>
</li>
</ul>
<p><strong>③ bounding box的置信度误差</strong><br>
公式第3行和第4行。</p>
<ul>
<li>第3行是存在对象的bounding box的置信度误差。带有 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mn>1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">1^{obj}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.379988em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9670159999999999em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span></span></span></span> 意味着只有"负责"（IOU比较大）预测的那个bounding box的置信度才会计入误差。</li>
<li>第4行是不存在对象的bounding box的置信度误差。因为不存在对象的bounding box应该老老实实的说"我这里没有对象"，也就是输出尽量低的置信度。如果它不恰当的输出较高的置信度，会与真正"负责"该对象预测的那个bounding box产生混淆。其实就像对象分类一样，正确的对象概率最好是1，所有其它对象的概率最好是0。</li>
<li>第4行会乘以  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\lambda_{noobj}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 调节不存在对象的bounding box的置信度的权重（相对其它误差）。YOLO设置 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mo>&lt;</mo></msub><mo stretchy="false">!</mo><mo>−</mo><mo>−</mo><mi mathvariant="normal">￼</mi><mn>10</mn><mo>−</mo><mo>−</mo><mo>&gt;</mo><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\lambda_=0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.87181em;vertical-align:-0.17737em;"></span><span class="mord"><span class="mord mathdefault">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.22737em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">&lt;</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17737em;"><span></span></span></span></span></span></span><span class="mclose">!</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">￼</span><span class="mord">1</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span></span> ，即调低不存在对象的bounding box的置信度误差的权重。</li>
</ul>
<p>&nbsp;</p>
<p>关于loss，需要特别注意的是需要计算loss的部分。并不是网络的输出都算loss，具体地说：</p>
<ol>
<li>有物体中心落入的cell，需要计算分类loss，两个predictor都要计算confidence loss，预测的bounding box与ground truth IOU比较大的那个predictor需要计算xywh loss。</li>
<li>特别注意：没有物体中心落入的cell，只需要计算confidence loss。</li>
</ol>
<p>另外，我们发现每一项loss的计算都是L2 loss，即使是分类问题也是。所以说yolo是把分类问题转为了回归问题。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="四-性能"><a class="markdownIt-Anchor" href="#四-性能"></a> 四. 性能</h2>
<h3 id="41-优点"><a class="markdownIt-Anchor" href="#41-优点"></a> 4.1 优点</h3>
<ul>
<li>
<p><strong>YOLO检测物体非常快</strong></p>
<p>因为没有复杂的检测流程，只需要将图像输入到神经网络就可以得到端对端检测结果。标准版本的YOLO每秒可以处理45帧图像，快速版可以达到150帧/s。因此，YOLO可以实现实时检测。</p>
</li>
<li>
<p><strong>YOLO实时监测的mAP（mean Average Precision）是之前其他实时物体检测系统的两倍以上</strong></p>
</li>
<li>
<p><strong>YOLO采用全图信息来进行预测</strong></p>
<p>不像其他物体检测系统使用了滑窗或region proposal，分类器只能得到图像的局部信息，会错误的将背景中的斑块检测为目标。YOLO在训练和测试时都能够看到一整张图像的信息，因此YOLO在检测物体时能很好的利用上下文信息，从而不容易在背景上预测出错误的物体信息。和Fast-R-CNN相比，YOLO的背景错误不到Fast-R-CNN的一半。</p>
</li>
<li>
<p><strong>YOLO可以学到物体的泛化特征</strong></p>
<p>YOLO可以学习到目标的概括信息（generalizable representation），具有一定普适性。当YOLO在自然图像上做训练，在艺术作品上做测试时，YOLO表现的性能比DPM、R-CNN等之前的物体检测系统要好很多。</p>
</li>
</ul>
<p>&nbsp;</p>
<h3 id="42-缺点"><a class="markdownIt-Anchor" href="#42-缺点"></a> 4.2 缺点</h3>
<ul>
<li>因为网格和bounding box设置的比较稀疏，所以这个版本的YOLO训练出来后预测的准确率和召回率都不是很理想，后续的v2、v3版本还会改进。</li>
<li>由于损失函数的问题，YOLO容易产生物体的定位错误。</li>
<li>YOLO对相互靠近或小物体的检测效果不好，尤其是密集的小物体，因为一个网格只能预测2个框（物体）。</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="五-其他"><a class="markdownIt-Anchor" href="#五-其他"></a> 五. 其他</h2>
<h4 id="51-yolo的bounding-box并不是faster-rcnn的anchor"><a class="markdownIt-Anchor" href="#51-yolo的bounding-box并不是faster-rcnn的anchor"></a> 5.1 YOLO的bounding box并不是Faster RCNN的Anchor</h4>
<p>Faster RCNN等一些算法采用每个grid中手工设置n个Anchor（先验框，预先设置好位置的bounding box）的设计，每个Anchor有不同的大小和宽高比。YOLO的bounding box看起来很像一个grid中2个Anchor，但它们不是。YOLO并没有预先设置2个bounding box的大小和形状，也没有对每个bounding box分别输出一个对象的预测。它的意思仅仅是对一个对象预测出2个bounding box，选择预测得相对比较准的那个。</p>
<p>这里采用2个bounding box，有点不完全算监督算法，而是像进化算法。如果是监督算法，我们需要<strong>事先</strong>根据样本就能给出一个正确的bounding box作为回归的目标。但YOLO的2个bounding box事先并不知道会在什么位置，只有经过前向计算，网络会输出2个bounding box，这两个bounding box与样本中对象实际的bounding box计算IOU。这时才能确定，IOU值大的那个bounding box，作为负责预测该对象的bounding box。<br>
训练开始阶段，网络预测的bounding box可能都是乱来的，但总是选择IOU相对好一些的那个，随着训练的进行，每个bounding box会逐渐擅长对某些情况的预测（可能是对象大小、宽高比、不同类型的对象等）。所以，这是一种进化或者非监督学习的思想。</p>
<p>&nbsp;</p>
<h4 id="52-预测inference"><a class="markdownIt-Anchor" href="#52-预测inference"></a> 5.2 预测（inference）</h4>
<p>训练好的YOLO网络，输入一张图片，将输出一个 7<em>7</em>30 的张量（tensor）来表示图片中所有网格包含的对象（概率）以及该对象可能的2个位置（bounding box）和可信程度（置信度）。<br>
为了从中提取出最有可能的那些对象和位置，YOLO采用NMS（Non-maximal suppression，非极大值抑制）算法。</p>
<p>&nbsp;</p>
<h4 id="53-nms非极大值抑制"><a class="markdownIt-Anchor" href="#53-nms非极大值抑制"></a> 5.3 NMS（非极大值抑制）</h4>
<p>NMS方法并不复杂，其核心思想是：选择得分最高的作为输出，与该输出重叠的去掉，不断重复这一过程直到所有备选处理完。</p>
<p>YOLO的NMS计算方法如下。<br>
网络输出的7<em>7</em>30的张量，在每一个网格中，对象位于第j个bounding box的得分：</p>
<p>它代表着某个对象存在于第j个bounding box的可能性。</p>
<p>每个网格有：20个对象的概率*2个bounding box的置信度，共40个得分（候选对象）。49个网格共1960个得分。Andrew Ng建议每种对象分别进行NMS，那么每种对象有 1960/20=98 个得分。</p>
<p>NMS步骤如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1）设置一个Score的阈值，低于该阈值的候选对象排除掉（将该Score设为0）</span><br><span class="line">2）遍历每一个对象类别</span><br><span class="line"> 2.1）遍历该对象的98个得分</span><br><span class="line">  2.1.1）找到Score最大的那个对象及其bounding box，添加到输出列表</span><br><span class="line">  2.1.2）对每个Score不为0的候选对象，计算其与上面2.1.1输出对象的bounding box的IOU</span><br><span class="line">  2.1.3）根据预先设置的IOU阈值，所有高于该阈值（重叠度较高）的候选对象排除掉（将Score设为0）</span><br><span class="line">  2.1.4）如果所有bounding box要么在输出列表中，要么Score=0，则该对象类别的NMS完成，返回步骤2处理下一种对象</span><br><span class="line">3）输出列表即为预测的对象</span><br></pre></td></tr></tbody></table></figure>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="六-源程序"><a class="markdownIt-Anchor" href="#六-源程序"></a> 六. 源程序</h2>
<p>代码的实现学习于一个大四学生的<a href="https://www.bilibili.com/video/BV1tb411e7jc" target="_blank" rel="noopener external nofollow noreferrer">直播课程</a>（比一比差距就来了。。。）。</p>
<p>以下代码是在看完视频后理解的基础上自己实现的，tensorflow版本为1.14 。代码结构如图12所示。</p>
<p><img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/12/UG9hid.png" alt="图12：代码结构"></p>
<p>&nbsp;</p>
<p><strong>训练图集为VOC数据集，为了方便，我直接使用的YOLO_small.ckpt权重文件。</strong></p>
<p>&nbsp;</p>
<h3 id="61-基于图片的目标检测"><a class="markdownIt-Anchor" href="#61-基于图片的目标检测"></a> 6.1 基于图片的目标检测</h3>
<p><font color="red">yolo_pic.py</font></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> cv2 <span class="keyword">import</span> cv2 <span class="keyword">as</span> cv2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># 构造函数：初始化yolo中S、B、C参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#支持检测的类别</span></span><br><span class="line">        self.classes = [<span class="string">"aeroplane"</span>, <span class="string">"bicycle"</span>, <span class="string">"bird"</span>, <span class="string">"boat"</span>, <span class="string">"bottle"</span>,</span><br><span class="line">                        <span class="string">"bus"</span>, <span class="string">"car"</span>, <span class="string">"cat"</span>, <span class="string">"chair"</span>, <span class="string">"cow"</span>, <span class="string">"diningtable"</span>,</span><br><span class="line">                        <span class="string">"dog"</span>, <span class="string">"horse"</span>, <span class="string">"motorbike"</span>, <span class="string">"person"</span>, <span class="string">"pottedplant"</span>,</span><br><span class="line">                        <span class="string">"sheep"</span>, <span class="string">"sofa"</span>, <span class="string">"train"</span>,<span class="string">"tvmonitor"</span>]</span><br><span class="line">        self.C = len(self.classes) <span class="comment"># 类别数</span></span><br><span class="line">        <span class="comment"># 边界框的中心坐标xy——相对于每个cell左上点的偏移量</span></span><br><span class="line">        self.x_offset = np.transpose(np.reshape(np.array([np.arange(<span class="number">7</span>)]*<span class="number">7</span>*<span class="number">2</span>), [<span class="number">2</span>, <span class="number">7</span>, <span class="number">7</span>]), [<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>])</span><br><span class="line">        self.y_offset = np.transpose(self.x_offset, [<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>])</span><br><span class="line">        <span class="comment">#x、y shape = (7,7,2)</span></span><br><span class="line"></span><br><span class="line">        self.threshold = <span class="number">0.2</span>  <span class="comment"># 类别置信度分数阈值</span></span><br><span class="line">        self.iou_threshold = <span class="number">0.5</span>  <span class="comment"># IOU阈值，小于0.4的会过滤掉</span></span><br><span class="line"></span><br><span class="line">        self.max_output_size = <span class="number">10</span>  <span class="comment"># NMS选择的边界框的最大数量</span></span><br><span class="line">        self.img_shape = (<span class="number">448</span>,<span class="number">448</span>)</span><br><span class="line"></span><br><span class="line">        self.batch_size = <span class="number">45</span></span><br><span class="line"></span><br><span class="line">        self.coord_scale = <span class="number">5.</span></span><br><span class="line">        self.noobject_scale = <span class="number">1.</span></span><br><span class="line">        self.object_scale = <span class="number">1.</span></span><br><span class="line">        self.class_scale = <span class="number">2.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaky_relu激活函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_relu</span><span class="params">(self,x, alpha=<span class="number">0.1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> tf.maximum(alpha * x, x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#################  网络部分</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_build_net</span><span class="params">(self)</span>:</span></span><br><span class="line">        x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">448</span>, <span class="number">448</span>, <span class="number">3</span>]) <span class="comment"># 输入、输出用占位符，因为尺寸一般不会改变</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment"># 搭建网络模型</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'yolo'</span>):</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_2'</span>):</span><br><span class="line">                net = self._conv_layer(x,  <span class="number">64</span>, <span class="number">7</span>, <span class="number">2</span>,<span class="string">'conv_2'</span>)</span><br><span class="line">            net = self._maxpool_layer(net,  <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_4'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">192</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_4'</span>)</span><br><span class="line">            net = self._maxpool_layer(net, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_6'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">128</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_6'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_7'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_7'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_8'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_8'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_9'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_9'</span>)</span><br><span class="line">            net = self._maxpool_layer(net, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_11'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_11'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_12'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_12'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_13'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_13'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_14'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_14'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_15'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_15'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_16'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_16'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_17'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_17'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_18'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_18'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_19'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_19'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_20'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_20'</span>)</span><br><span class="line">            net = self._maxpool_layer(net, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_22'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">512</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_22'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_23'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_23'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_24'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">512</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_24'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_25'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_25'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_26'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_26'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_28'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">2</span>,<span class="string">'conv_28'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_29'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_29'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_30'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_30'</span>)</span><br><span class="line">            net = self._flatten(net)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'fc_33'</span>):</span><br><span class="line">                net = self._fc_layer(net,  <span class="number">512</span>, activation=self.leak_relu,scope=<span class="string">'fc_33'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'fc_34'</span>):</span><br><span class="line">                net = self._fc_layer(net, <span class="number">4096</span>, activation=self.leak_relu,scope=<span class="string">'fc_34'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'fc_36'</span>):</span><br><span class="line">                net = self._fc_layer(net, <span class="number">7</span>*<span class="number">7</span>*<span class="number">30</span>,scope=<span class="string">'fc_36'</span>)</span><br><span class="line">        <span class="keyword">return</span> net,x</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 卷积层：x输入；num_filters：卷积核个数；filter_size：卷积核尺寸；stride：步长</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_conv_layer</span><span class="params">(self, x, num_filters, filter_size, stride,scope)</span>:</span></span><br><span class="line">        <span class="comment"># 通道数</span></span><br><span class="line">        in_channels = x.get_shape().as_list()[<span class="number">-1</span>]</span><br><span class="line">        <span class="comment"># 均值为0标准差为0.1的正态分布，初始化权重w；shape=行*列*通道数*卷积核个数</span></span><br><span class="line">        weight = tf.Variable(tf.truncated_normal([filter_size, filter_size,in_channels, num_filters], stddev=<span class="number">0.1</span>),name=<span class="string">'weights'</span>)</span><br><span class="line">        bias = tf.Variable(tf.zeros([num_filters,]),name=<span class="string">'biases'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># padding, 注意: 不用padding="SAME",否则可能会导致坐标计算错误</span></span><br><span class="line">        pad_size = filter_size // <span class="number">2</span></span><br><span class="line">        pad_mat = np.array([[<span class="number">0</span>, <span class="number">0</span>], [pad_size, pad_size], [pad_size, pad_size], [<span class="number">0</span>, <span class="number">0</span>]])</span><br><span class="line">        x_pad = tf.pad(x, pad_mat)</span><br><span class="line">        conv = tf.nn.conv2d(x_pad, weight, strides=[<span class="number">1</span>, stride, stride, <span class="number">1</span>], padding=<span class="string">"VALID"</span>,name=scope)</span><br><span class="line">        output = self.leak_relu(tf.nn.bias_add(conv, bias))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 全连接层：x输入；num_out：输出尺寸；activation：激活函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_fc_layer</span><span class="params">(self, x,  num_out, activation=None,scope=None)</span>:</span></span><br><span class="line"></span><br><span class="line">        num_in = x.get_shape().as_list()[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 均值为0标准差为0.1的正态分布，初始化权重w；shape=行*列*通道数*卷积核个数</span></span><br><span class="line">        weight = tf.Variable(tf.truncated_normal([num_in, num_out], stddev=<span class="number">0.1</span>),name=<span class="string">'weights'</span>)</span><br><span class="line">        bias = tf.Variable(tf.zeros([num_out,]),name=<span class="string">'biases'</span>)</span><br><span class="line">        output = tf.nn.xw_plus_b(x, weight, bias,name=scope)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 正常全连接层是leak_relu激活函数；但是最后一层是liner函数</span></span><br><span class="line">        <span class="keyword">if</span> activation:</span><br><span class="line">            output = activation(output)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 池化层：x输入；pool_size：池化尺寸；stride：步长</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_maxpool_layer</span><span class="params">(self, x,  pool_size, stride)</span>:</span></span><br><span class="line">        output = tf.nn.max_pool(x, [<span class="number">1</span>, pool_size, pool_size, <span class="number">1</span>],</span><br><span class="line">                                strides=[<span class="number">1</span>, stride, stride, <span class="number">1</span>], padding=<span class="string">"SAME"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 拉直层：因为接下来会连接全连接层，例如[n_samples, 7, 7, 32] -&gt; [n_samples, 7*7*32]</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_flatten</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="string">"""flatten the x"""</span></span><br><span class="line">        tran_x = tf.transpose(x, [<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>])  <span class="comment"># channle first mode</span></span><br><span class="line">        nums = np.product(x.get_shape().as_list()[<span class="number">1</span>:])</span><br><span class="line">        <span class="keyword">return</span> tf.reshape(tran_x, [<span class="number">-1</span>, nums])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############   IOU</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(self,predicition)</span>:</span></span><br><span class="line">        cls = tf.reshape(predicition[<span class="number">0</span>,:<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span>],[<span class="number">7</span>,<span class="number">7</span>,<span class="number">20</span>])</span><br><span class="line">        confidence = tf.reshape(predicition[<span class="number">0</span>,<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span>:<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span> + <span class="number">7</span>*<span class="number">7</span>*<span class="number">2</span>],[<span class="number">7</span>,<span class="number">7</span>,<span class="number">2</span>])</span><br><span class="line">        boxes = tf.reshape(predicition[<span class="number">0</span>,<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span> + <span class="number">7</span>*<span class="number">7</span>*<span class="number">2</span>:],[<span class="number">7</span>,<span class="number">7</span>,<span class="number">2</span>,<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#true box = (x,y,w**2,h**2) 乘以图像的宽度和高度</span></span><br><span class="line">        boxes = tf.stack(</span><br><span class="line">            [</span><br><span class="line">                (boxes[:,:,:,<span class="number">0</span>] + tf.constant(self.x_offset,dtype=tf.float32)) / <span class="number">7</span> * self.img_shape[<span class="number">0</span>],</span><br><span class="line">                (boxes[:,:,:,<span class="number">1</span>] + tf.constant(self.y_offset,dtype=tf.float32)) / <span class="number">7</span> * self.img_shape[<span class="number">1</span>],</span><br><span class="line">                tf.square(boxes[:,:,:,<span class="number">2</span>]) * self.img_shape[<span class="number">0</span>],</span><br><span class="line">                tf.square(boxes[:,:,:,<span class="number">3</span>]) * self.img_shape[<span class="number">1</span>]</span><br><span class="line">             ],axis=<span class="number">3</span></span><br><span class="line">        )</span><br><span class="line">        scores = tf.expand_dims(confidence, <span class="number">-1</span>) * tf.expand_dims(cls, <span class="number">2</span>)</span><br><span class="line">        <span class="comment">#print(scores)</span></span><br><span class="line">        scores = tf.reshape(scores, [<span class="number">-1</span>, <span class="number">20</span>])</span><br><span class="line"></span><br><span class="line">        boxes = tf.reshape(boxes, [<span class="number">-1</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#拿到每个box的类别与得分</span></span><br><span class="line">        box_classes = tf.argmax(scores, axis=<span class="number">1</span>)</span><br><span class="line">        box_class_scores = tf.reduce_max(scores, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#过滤</span></span><br><span class="line">        filter_mask = box_class_scores &gt;= self.threshold</span><br><span class="line">        scores = tf.boolean_mask(box_class_scores, filter_mask)</span><br><span class="line">        boxes = tf.boolean_mask(boxes, filter_mask)</span><br><span class="line">        box_classes = tf.boolean_mask(box_classes, filter_mask)</span><br><span class="line"></span><br><span class="line">        _boxes = tf.stack([boxes[:, <span class="number">0</span>] - <span class="number">0.5</span> * boxes[:, <span class="number">2</span>], boxes[:, <span class="number">1</span>] - <span class="number">0.5</span> * boxes[:, <span class="number">3</span>],</span><br><span class="line">                           boxes[:, <span class="number">0</span>] + <span class="number">0.5</span> * boxes[:, <span class="number">2</span>], boxes[:, <span class="number">1</span>] + <span class="number">0.5</span> * boxes[:, <span class="number">3</span>]], axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        nms_indices = tf.image.non_max_suppression(_boxes, scores,</span><br><span class="line">                                                   self.max_output_size, self.iou_threshold)</span><br><span class="line">        scores = tf.gather(scores, nms_indices)</span><br><span class="line">        boxes = tf.gather(boxes, nms_indices)</span><br><span class="line">        box_classes = tf.gather(box_classes, nms_indices)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> scores,boxes,box_classes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calc_iou</span><span class="params">(self,bboxes1, bboxes2)</span>:</span></span><br><span class="line">        bboxes1 = np.transpose(bboxes1)</span><br><span class="line">        bboxes2 = np.transpose(bboxes2)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算两个box的交集：交集左上角的点取两个box的max，交集右下角的点取两个box的min</span></span><br><span class="line">        int_ymin = np.maximum(bboxes1[<span class="number">0</span>], bboxes2[<span class="number">0</span>])</span><br><span class="line">        int_xmin = np.maximum(bboxes1[<span class="number">1</span>], bboxes2[<span class="number">1</span>])</span><br><span class="line">        int_ymax = np.minimum(bboxes1[<span class="number">2</span>], bboxes2[<span class="number">2</span>])</span><br><span class="line">        int_xmax = np.minimum(bboxes1[<span class="number">3</span>], bboxes2[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算两个box交集的wh：如果两个box没有交集，那么wh为0(按照计算方式wh为负数，跟0比较取最大值)</span></span><br><span class="line">        int_h = np.maximum(int_ymax - int_ymin, <span class="number">0.</span>)</span><br><span class="line">        int_w = np.maximum(int_xmax - int_xmin, <span class="number">0.</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算IOU</span></span><br><span class="line">        int_vol = int_h * int_w  <span class="comment"># 交集面积</span></span><br><span class="line">        vol1 = (bboxes1[<span class="number">2</span>] - bboxes1[<span class="number">0</span>]) * (bboxes1[<span class="number">3</span>] - bboxes1[<span class="number">1</span>])  <span class="comment"># bboxes1面积</span></span><br><span class="line">        vol2 = (bboxes2[<span class="number">2</span>] - bboxes2[<span class="number">0</span>]) * (bboxes2[<span class="number">3</span>] - bboxes2[<span class="number">1</span>])  <span class="comment"># bboxes2面积</span></span><br><span class="line">        iou = int_vol / (vol1 + vol2 - int_vol)  <span class="comment"># IOU=交集/并集</span></span><br><span class="line">        <span class="keyword">return</span> iou</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loss_layer</span><span class="params">(self, predicts, labels, scope=<span class="string">'loss_layer'</span>)</span>:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">#label为（(45,7,7,25)）  5个为盒子信息  (x,y,w,h,c)  后20个为类别</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            <span class="comment"># 预测值</span></span><br><span class="line">            <span class="comment"># class-20</span></span><br><span class="line">            predict_classes = tf.reshape(</span><br><span class="line">                predicts[:, :<span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">20</span>])</span><br><span class="line">            <span class="comment"># confidence-2</span></span><br><span class="line">            predict_confidence = tf.reshape(</span><br><span class="line">                predicts[:, <span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span>:<span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span> + <span class="number">7</span> * <span class="number">7</span> * <span class="number">2</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">2</span>])</span><br><span class="line">            <span class="comment"># bounding box-2*4</span></span><br><span class="line">            predict_boxes = tf.reshape(</span><br><span class="line">                predicts[:, <span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span> + <span class="number">7</span> * <span class="number">7</span> * <span class="number">2</span>:],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 实际值</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,1)</span></span><br><span class="line">            <span class="comment"># response中的值为0或者1.对应的网格中存在目标为1，不存在目标为0.</span></span><br><span class="line">            <span class="comment"># 存在目标指的是存在目标的中心点，并不是说存在目标的一部分。所以，目标的中心点所在的cell其对应的值才为1，其余的值均为0</span></span><br><span class="line">            response = tf.reshape(</span><br><span class="line">                labels[..., <span class="number">0</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>])</span><br><span class="line">            <span class="comment"># shape(45,7,7,1,4)</span></span><br><span class="line">            boxes = tf.reshape(</span><br><span class="line">                labels[..., <span class="number">1</span>:<span class="number">5</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">4</span>])</span><br><span class="line">            <span class="comment"># shape(45,7,7,2,4),boxes的四个值，取值范围为0~1</span></span><br><span class="line">            boxes = tf.tile(</span><br><span class="line">                boxes, [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]) / self.img_shape[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># shape(45,7,7,20)</span></span><br><span class="line">            classes = labels[..., <span class="number">5</span>:]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># self.offset shape(7,7,2)</span></span><br><span class="line">            <span class="comment"># offset shape(1,7,7,2)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># shape(45,7,7,2)</span></span><br><span class="line">            x_offset = tf.tile(self.x_offset, [self.batch_size, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>])  <span class="comment">#(45,7,7,2)</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,2)</span></span><br><span class="line">            y_offset = tf.transpose(x_offset, (<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># convert the x, y to the coordinates relative to the top left point of the image</span></span><br><span class="line">            <span class="comment"># the predictions of w, h are the square root</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,2,4)  -&gt;(x,y,w,h)</span></span><br><span class="line">            predict_boxes_tran = tf.stack(</span><br><span class="line">                [(predict_boxes[..., <span class="number">0</span>] + x_offset) / <span class="number">7</span>,</span><br><span class="line">                 (predict_boxes[..., <span class="number">1</span>] + y_offset) / <span class="number">7</span>,</span><br><span class="line">                 tf.square(predict_boxes[..., <span class="number">2</span>]),</span><br><span class="line">                 tf.square(predict_boxes[..., <span class="number">3</span>])], axis=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 预测box与真实box的IOU,shape(45,7,7,2)</span></span><br><span class="line">            iou_predict_truth = self.calc_iou(predict_boxes_tran, boxes)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate I tensor [BATCH_SIZE, CELL_SIZE, CELL_SIZE, BOXES_PER_CELL]</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,1), find the maximum iou_predict_truth in every cell</span></span><br><span class="line">            <span class="comment"># 在训练时，如果该单元格内确实存在目标，那么只选择IOU最大的那个边界框来负责预测该目标，而其它边界框认为不存在目标</span></span><br><span class="line">            object_mask = tf.reduce_max(iou_predict_truth, <span class="number">3</span>, keep_dims=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># object probs (45,7,7,2)</span></span><br><span class="line">            object_mask = tf.cast(</span><br><span class="line">                (iou_predict_truth &gt;= object_mask), tf.float32) * response</span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate no_I tensor [CELL_SIZE, CELL_SIZE, BOXES_PER_CELL]</span></span><br><span class="line">            <span class="comment"># noobject confidence(45,7,7,2)</span></span><br><span class="line">            noobject_probs = tf.ones_like(</span><br><span class="line">                object_mask, dtype=tf.float32) - object_mask</span><br><span class="line"></span><br><span class="line">            <span class="comment"># shape(45,7,7,2,4)，对boxes的四个值进行规整，xy为相对于网格左上角，wh为取根号后的值，范围0~1</span></span><br><span class="line">            boxes_tran = tf.stack(</span><br><span class="line">                [boxes[..., <span class="number">0</span>] * <span class="number">7</span> - x_offset,</span><br><span class="line">                 boxes[..., <span class="number">1</span>] * <span class="number">7</span> - y_offset,</span><br><span class="line">                 tf.sqrt(boxes[..., <span class="number">2</span>]),</span><br><span class="line">                 tf.sqrt(boxes[..., <span class="number">3</span>])], axis=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># class_loss shape(45,7,7,20)</span></span><br><span class="line">            class_delta = response * (predict_classes - classes)</span><br><span class="line">            class_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(class_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'class_loss'</span>) * self.class_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># object_loss  confidence=iou*p(object)</span></span><br><span class="line">            <span class="comment"># p(object)的值为1或0</span></span><br><span class="line">            object_delta = object_mask * (predict_confidence - iou_predict_truth)</span><br><span class="line">            object_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(object_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'object_loss'</span>) * self.object_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># noobject_loss  p(object)的值为0</span></span><br><span class="line">            noobject_delta = noobject_probs * predict_confidence</span><br><span class="line">            noobject_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(noobject_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'noobject_loss'</span>) * self.noobject_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># coord_loss</span></span><br><span class="line">            coord_mask = tf.expand_dims(object_mask, <span class="number">4</span>)</span><br><span class="line">            boxes_delta = coord_mask * (predict_boxes - boxes_tran)</span><br><span class="line">            coord_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(boxes_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]),</span><br><span class="line">                name=<span class="string">'coord_loss'</span>) * self.coord_scale</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> class_loss+object_loss+noobject_loss+coord_loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train_yolo</span><span class="params">(self)</span>:</span></span><br><span class="line">        global_step = tf.train.create_global_step()</span><br><span class="line">        learning_rate = tf.train.exponential_decay(</span><br><span class="line">            <span class="number">0.0001</span>, global_step, <span class="number">30000</span>,</span><br><span class="line">            <span class="number">0.1</span>, <span class="literal">True</span>, name=<span class="string">'learning_rate'</span>)</span><br><span class="line">        op = tf.train.GradientDescentOptimizer(learning_rate).minimize()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_detect_from_image</span><span class="params">(self, image)</span>:</span></span><br><span class="line"></span><br><span class="line">        img_resized = cv2.resize(image, (<span class="number">448</span>, <span class="number">448</span>))</span><br><span class="line">        self.img = img_resized</span><br><span class="line">        img_RGB = cv2.cvtColor(img_resized, cv2.COLOR_BGR2RGB)</span><br><span class="line">        img_RGB = np.expand_dims(img_RGB,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        img_resized_np = np.asarray(img_RGB)</span><br><span class="line">        _images = np.zeros((<span class="number">1</span>, <span class="number">448</span>, <span class="number">448</span>, <span class="number">3</span>), dtype=np.float32)</span><br><span class="line">        _images[<span class="number">0</span>] = (img_resized_np / <span class="number">255.0</span>) * <span class="number">2.0</span> - <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _images</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">draw_rectangle</span><span class="params">(self,img, classes, scores, bboxes, colors, thickness=<span class="number">2</span>)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(bboxes.shape[<span class="number">0</span>]):</span><br><span class="line">            x = int(bboxes[i][<span class="number">0</span>])</span><br><span class="line">            y = int(bboxes[i][<span class="number">1</span>])</span><br><span class="line">            w = int(bboxes[i][<span class="number">2</span>]) // <span class="number">2</span></span><br><span class="line">            h = int(bboxes[i][<span class="number">3</span>]) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">            print(<span class="string">"[x, y, w, h]=[%d, %d, %d, %d]"</span> % (x, y, w, h))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 中心坐标 + 宽高box(x, y, w, h) -&gt; xmin = x - w / 2 -&gt; 左上 + 右下box(xmin, ymin, xmax, ymax)</span></span><br><span class="line">            cv2.rectangle(img, (x - w, y - h), (x + w, y + h), colors[<span class="number">0</span>], thickness)</span><br><span class="line">            <span class="comment"># 在边界框上显示类别、分数(类别置信度)</span></span><br><span class="line">            s = <span class="string">'%s/%.3f'</span> % (self.classes[classes[i]], scores[i])</span><br><span class="line">            cv2.rectangle(img, (x - w, y - h - <span class="number">20</span>), (x + w, y - h), (<span class="number">125</span>, <span class="number">125</span>, <span class="number">125</span>), <span class="number">-1</span>)</span><br><span class="line">            cv2.putText(img, s, (x - w + <span class="number">5</span>, y - h - <span class="number">7</span>),</span><br><span class="line">                        cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.5</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">1</span>)</span><br><span class="line">        cv2.namedWindow(<span class="string">"img"</span>, <span class="number">0</span>)</span><br><span class="line">        cv2.resizeWindow(<span class="string">"img"</span>, <span class="number">640</span>, <span class="number">480</span>)</span><br><span class="line">        cv2.imshow(<span class="string">'img'</span>, img)</span><br><span class="line">        cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">        cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    yo = Yolo()</span><br><span class="line"></span><br><span class="line">    pred,x = yo._build_net()</span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess = tf.Session()</span><br><span class="line">    checkpoint_path = <span class="string">'./model/v1/YOLO_small.ckpt'</span></span><br><span class="line">    saver = tf.train.Saver()</span><br><span class="line">    sess.run(init)</span><br><span class="line">    saver.restore(sess, checkpoint_path)</span><br><span class="line"></span><br><span class="line">    img = cv2.imread(<span class="string">'./test/5.jpg'</span>)</span><br><span class="line">    img = yo._detect_from_image(img)</span><br><span class="line"></span><br><span class="line">    scores, boxes, box_classes = yo.filter(pred)</span><br><span class="line">    scores, boxes, box_classes = sess.run([scores, boxes, box_classes],feed_dict={x:img})</span><br><span class="line">    print(<span class="string">'置信度：'</span>,end=<span class="string">""</span>)</span><br><span class="line">    print(scores)</span><br><span class="line">    print(<span class="string">'类别信息：'</span>,end=<span class="string">""</span>)</span><br><span class="line">    print(box_classes)</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    yo.draw_rectangle(yo.img,box_classes,scores,boxes,[[<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>],[<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>]])</span><br></pre></td></tr></tbody></table></figure>
<p><font color="red">运行结果：</font></p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/11/U1Zy9J.jpg" alt="图13：检测成功的样例" style="zoom: 60%;">
<p>程序正确输出“人”和“猫”两个物体（第7和第14，参见代码中<code>self.classes</code>）。并标注了他们各自bbox的位置、置信度信息。</p>
<p>另外，我拍摄了一张行人、车辆都很密集的图片，想以此来看一下YOLO v1是否真的扛不住。果不其然…</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/11/U1mTOI.jpg" alt="图14：检测失败的样例" style="zoom: 67%;">
<p>从测试结果看到，在这张图片中，程序没有检测到任何东西。一定程度上佐证了YOLO对相互靠近或小物体的检测效果不好，尤其是密集的小物体！</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3 id="62-基于视频的目标检测"><a class="markdownIt-Anchor" href="#62-基于视频的目标检测"></a> 6.2 基于视频的目标检测</h3>
<p>毕竟YOLO算法是用于实时场景的，所以仅仅对图片检测是不够的，视频形式的检测必不可少。测试视频是我在公交车上用手机拍摄的，取景于济宁市一个不知名的十字路口。原本以为也会因为内容过于密集而检测失败，但结果还是不错的。</p>
<p><font color="red">yolo_video.py</font></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> cv2 <span class="keyword">import</span> cv2 <span class="keyword">as</span> cv2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># 构造函数：初始化yolo中S、B、C参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#支持检测的类别</span></span><br><span class="line">        self.classes = [<span class="string">"aeroplane"</span>, <span class="string">"bicycle"</span>, <span class="string">"bird"</span>, <span class="string">"boat"</span>, <span class="string">"bottle"</span>,</span><br><span class="line">                        <span class="string">"bus"</span>, <span class="string">"car"</span>, <span class="string">"cat"</span>, <span class="string">"chair"</span>, <span class="string">"cow"</span>, <span class="string">"diningtable"</span>,</span><br><span class="line">                        <span class="string">"dog"</span>, <span class="string">"horse"</span>, <span class="string">"motorbike"</span>, <span class="string">"person"</span>, <span class="string">"pottedplant"</span>,</span><br><span class="line">                        <span class="string">"sheep"</span>, <span class="string">"sofa"</span>, <span class="string">"train"</span>,<span class="string">"tvmonitor"</span>]</span><br><span class="line">        self.C = len(self.classes) <span class="comment"># 类别数</span></span><br><span class="line">        <span class="comment"># 边界框的中心坐标xy——相对于每个cell左上点的偏移量</span></span><br><span class="line">        self.x_offset = np.transpose(np.reshape(np.array([np.arange(<span class="number">7</span>)]*<span class="number">7</span>*<span class="number">2</span>), [<span class="number">2</span>, <span class="number">7</span>, <span class="number">7</span>]), [<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>])</span><br><span class="line">        self.y_offset = np.transpose(self.x_offset, [<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>])</span><br><span class="line">        <span class="comment">#x、y shape = (7,7,2)</span></span><br><span class="line"></span><br><span class="line">        self.threshold = <span class="number">0.2</span>  <span class="comment"># 类别置信度分数阈值</span></span><br><span class="line">        self.iou_threshold = <span class="number">0.5</span>  <span class="comment"># IOU阈值，小于0.4的会过滤掉</span></span><br><span class="line"></span><br><span class="line">        self.max_output_size = <span class="number">10</span>  <span class="comment"># NMS选择的边界框的最大数量</span></span><br><span class="line">        self.img_shape = (<span class="number">448</span>,<span class="number">448</span>)</span><br><span class="line"></span><br><span class="line">        self.batch_size = <span class="number">45</span></span><br><span class="line"></span><br><span class="line">        self.coord_scale = <span class="number">5.</span></span><br><span class="line">        self.noobject_scale = <span class="number">1.</span></span><br><span class="line">        self.object_scale = <span class="number">1.</span></span><br><span class="line">        self.class_scale = <span class="number">2.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaky_relu激活函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_relu</span><span class="params">(self,x, alpha=<span class="number">0.1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> tf.maximum(alpha * x, x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#################  网络部分</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_build_net</span><span class="params">(self)</span>:</span></span><br><span class="line">        x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">448</span>, <span class="number">448</span>, <span class="number">3</span>]) <span class="comment"># 输入、输出用占位符，因为尺寸一般不会改变</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment"># 搭建网络模型</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'yolo'</span>):</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_2'</span>):</span><br><span class="line">                net = self._conv_layer(x,  <span class="number">64</span>, <span class="number">7</span>, <span class="number">2</span>,<span class="string">'conv_2'</span>)</span><br><span class="line">            net = self._maxpool_layer(net,  <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_4'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">192</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_4'</span>)</span><br><span class="line">            net = self._maxpool_layer(net, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_6'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">128</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_6'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_7'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_7'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_8'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_8'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_9'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_9'</span>)</span><br><span class="line">            net = self._maxpool_layer(net, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_11'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_11'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_12'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_12'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_13'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_13'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_14'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_14'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_15'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_15'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_16'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_16'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_17'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_17'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_18'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_18'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_19'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">512</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_19'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_20'</span>):</span><br><span class="line">                net = self._conv_layer(net, <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_20'</span>)</span><br><span class="line">            net = self._maxpool_layer(net, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_22'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">512</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_22'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_23'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_23'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_24'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">512</span>, <span class="number">1</span>, <span class="number">1</span>,<span class="string">'conv_24'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_25'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_25'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_26'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_26'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_28'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">2</span>,<span class="string">'conv_28'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_29'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_29'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv_30'</span>):</span><br><span class="line">                net = self._conv_layer(net,  <span class="number">1024</span>, <span class="number">3</span>, <span class="number">1</span>,<span class="string">'conv_30'</span>)</span><br><span class="line">            net = self._flatten(net)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'fc_33'</span>):</span><br><span class="line">                net = self._fc_layer(net,  <span class="number">512</span>, activation=self.leak_relu,scope=<span class="string">'fc_33'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'fc_34'</span>):</span><br><span class="line">                net = self._fc_layer(net, <span class="number">4096</span>, activation=self.leak_relu,scope=<span class="string">'fc_34'</span>)</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'fc_36'</span>):</span><br><span class="line">                net = self._fc_layer(net, <span class="number">7</span>*<span class="number">7</span>*<span class="number">30</span>,scope=<span class="string">'fc_36'</span>)</span><br><span class="line">        <span class="keyword">return</span> net,x</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 卷积层：x输入；num_filters：卷积核个数；filter_size：卷积核尺寸；stride：步长</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_conv_layer</span><span class="params">(self, x, num_filters, filter_size, stride,scope)</span>:</span></span><br><span class="line">        <span class="comment"># 通道数</span></span><br><span class="line">        in_channels = x.get_shape().as_list()[<span class="number">-1</span>]</span><br><span class="line">        <span class="comment"># 均值为0标准差为0.1的正态分布，初始化权重w；shape=行*列*通道数*卷积核个数</span></span><br><span class="line">        weight = tf.Variable(tf.truncated_normal([filter_size, filter_size,in_channels, num_filters], stddev=<span class="number">0.1</span>),name=<span class="string">'weights'</span>)</span><br><span class="line">        bias = tf.Variable(tf.zeros([num_filters,]),name=<span class="string">'biases'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># padding, 注意: 不用padding="SAME",否则可能会导致坐标计算错误</span></span><br><span class="line">        pad_size = filter_size // <span class="number">2</span></span><br><span class="line">        pad_mat = np.array([[<span class="number">0</span>, <span class="number">0</span>], [pad_size, pad_size], [pad_size, pad_size], [<span class="number">0</span>, <span class="number">0</span>]])</span><br><span class="line">        x_pad = tf.pad(x, pad_mat)</span><br><span class="line">        conv = tf.nn.conv2d(x_pad, weight, strides=[<span class="number">1</span>, stride, stride, <span class="number">1</span>], padding=<span class="string">"VALID"</span>,name=scope)</span><br><span class="line">        output = self.leak_relu(tf.nn.bias_add(conv, bias))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 全连接层：x输入；num_out：输出尺寸；activation：激活函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_fc_layer</span><span class="params">(self, x,  num_out, activation=None,scope=None)</span>:</span></span><br><span class="line"></span><br><span class="line">        num_in = x.get_shape().as_list()[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 均值为0标准差为0.1的正态分布，初始化权重w；shape=行*列*通道数*卷积核个数</span></span><br><span class="line">        weight = tf.Variable(tf.truncated_normal([num_in, num_out], stddev=<span class="number">0.1</span>),name=<span class="string">'weights'</span>)</span><br><span class="line">        bias = tf.Variable(tf.zeros([num_out,]),name=<span class="string">'biases'</span>)</span><br><span class="line">        output = tf.nn.xw_plus_b(x, weight, bias,name=scope)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 正常全连接层是leak_relu激活函数；但是最后一层是liner函数</span></span><br><span class="line">        <span class="keyword">if</span> activation:</span><br><span class="line">            output = activation(output)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 池化层：x输入；pool_size：池化尺寸；stride：步长</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_maxpool_layer</span><span class="params">(self, x,  pool_size, stride)</span>:</span></span><br><span class="line">        output = tf.nn.max_pool(x, [<span class="number">1</span>, pool_size, pool_size, <span class="number">1</span>],</span><br><span class="line">                                strides=[<span class="number">1</span>, stride, stride, <span class="number">1</span>], padding=<span class="string">"SAME"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 拉直层：因为接下来会连接全连接层，例如[n_samples, 7, 7, 32] -&gt; [n_samples, 7*7*32]</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_flatten</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="string">"""flatten the x"""</span></span><br><span class="line">        tran_x = tf.transpose(x, [<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>])  <span class="comment"># channle first mode</span></span><br><span class="line">        nums = np.product(x.get_shape().as_list()[<span class="number">1</span>:])</span><br><span class="line">        <span class="keyword">return</span> tf.reshape(tran_x, [<span class="number">-1</span>, nums])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############   IOU</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(self,predicition)</span>:</span></span><br><span class="line">        cls = tf.reshape(predicition[<span class="number">0</span>,:<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span>],[<span class="number">7</span>,<span class="number">7</span>,<span class="number">20</span>])</span><br><span class="line">        confidence = tf.reshape(predicition[<span class="number">0</span>,<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span>:<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span> + <span class="number">7</span>*<span class="number">7</span>*<span class="number">2</span>],[<span class="number">7</span>,<span class="number">7</span>,<span class="number">2</span>])</span><br><span class="line">        boxes = tf.reshape(predicition[<span class="number">0</span>,<span class="number">7</span>*<span class="number">7</span>*<span class="number">20</span> + <span class="number">7</span>*<span class="number">7</span>*<span class="number">2</span>:],[<span class="number">7</span>,<span class="number">7</span>,<span class="number">2</span>,<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#true box = (x,y,w**2,h**2) 乘以图像的宽度和高度</span></span><br><span class="line">        boxes = tf.stack(</span><br><span class="line">            [</span><br><span class="line">                (boxes[:,:,:,<span class="number">0</span>] + tf.constant(self.x_offset,dtype=tf.float32)) / <span class="number">7</span> * self.img_shape[<span class="number">0</span>],</span><br><span class="line">                (boxes[:,:,:,<span class="number">1</span>] + tf.constant(self.y_offset,dtype=tf.float32)) / <span class="number">7</span> * self.img_shape[<span class="number">1</span>],</span><br><span class="line">                tf.square(boxes[:,:,:,<span class="number">2</span>]) * self.img_shape[<span class="number">0</span>],</span><br><span class="line">                tf.square(boxes[:,:,:,<span class="number">3</span>]) * self.img_shape[<span class="number">1</span>]</span><br><span class="line">             ],axis=<span class="number">3</span></span><br><span class="line">        )</span><br><span class="line">        scores = tf.expand_dims(confidence, <span class="number">-1</span>) * tf.expand_dims(cls, <span class="number">2</span>)</span><br><span class="line">        <span class="comment">#print(scores)</span></span><br><span class="line">        scores = tf.reshape(scores, [<span class="number">-1</span>, <span class="number">20</span>])</span><br><span class="line"></span><br><span class="line">        boxes = tf.reshape(boxes, [<span class="number">-1</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#拿到每个box的类别与得分</span></span><br><span class="line">        box_classes = tf.argmax(scores, axis=<span class="number">1</span>)</span><br><span class="line">        box_class_scores = tf.reduce_max(scores, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#过滤</span></span><br><span class="line">        filter_mask = box_class_scores &gt;= self.threshold</span><br><span class="line">        scores = tf.boolean_mask(box_class_scores, filter_mask)</span><br><span class="line">        boxes = tf.boolean_mask(boxes, filter_mask)</span><br><span class="line">        box_classes = tf.boolean_mask(box_classes, filter_mask)</span><br><span class="line"></span><br><span class="line">        _boxes = tf.stack([boxes[:, <span class="number">0</span>] - <span class="number">0.5</span> * boxes[:, <span class="number">2</span>], boxes[:, <span class="number">1</span>] - <span class="number">0.5</span> * boxes[:, <span class="number">3</span>],</span><br><span class="line">                           boxes[:, <span class="number">0</span>] + <span class="number">0.5</span> * boxes[:, <span class="number">2</span>], boxes[:, <span class="number">1</span>] + <span class="number">0.5</span> * boxes[:, <span class="number">3</span>]], axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        nms_indices = tf.image.non_max_suppression(_boxes, scores,</span><br><span class="line">                                                   self.max_output_size, self.iou_threshold)</span><br><span class="line">        scores = tf.gather(scores, nms_indices)</span><br><span class="line">        boxes = tf.gather(boxes, nms_indices)</span><br><span class="line">        box_classes = tf.gather(box_classes, nms_indices)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> scores,boxes,box_classes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calc_iou</span><span class="params">(self,bboxes1, bboxes2)</span>:</span></span><br><span class="line">        bboxes1 = np.transpose(bboxes1)</span><br><span class="line">        bboxes2 = np.transpose(bboxes2)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算两个box的交集：交集左上角的点取两个box的max，交集右下角的点取两个box的min</span></span><br><span class="line">        int_ymin = np.maximum(bboxes1[<span class="number">0</span>], bboxes2[<span class="number">0</span>])</span><br><span class="line">        int_xmin = np.maximum(bboxes1[<span class="number">1</span>], bboxes2[<span class="number">1</span>])</span><br><span class="line">        int_ymax = np.minimum(bboxes1[<span class="number">2</span>], bboxes2[<span class="number">2</span>])</span><br><span class="line">        int_xmax = np.minimum(bboxes1[<span class="number">3</span>], bboxes2[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算两个box交集的wh：如果两个box没有交集，那么wh为0(按照计算方式wh为负数，跟0比较取最大值)</span></span><br><span class="line">        int_h = np.maximum(int_ymax - int_ymin, <span class="number">0.</span>)</span><br><span class="line">        int_w = np.maximum(int_xmax - int_xmin, <span class="number">0.</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算IOU</span></span><br><span class="line">        int_vol = int_h * int_w  <span class="comment"># 交集面积</span></span><br><span class="line">        vol1 = (bboxes1[<span class="number">2</span>] - bboxes1[<span class="number">0</span>]) * (bboxes1[<span class="number">3</span>] - bboxes1[<span class="number">1</span>])  <span class="comment"># bboxes1面积</span></span><br><span class="line">        vol2 = (bboxes2[<span class="number">2</span>] - bboxes2[<span class="number">0</span>]) * (bboxes2[<span class="number">3</span>] - bboxes2[<span class="number">1</span>])  <span class="comment"># bboxes2面积</span></span><br><span class="line">        iou = int_vol / (vol1 + vol2 - int_vol)  <span class="comment"># IOU=交集/并集</span></span><br><span class="line">        <span class="keyword">return</span> iou</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loss_layer</span><span class="params">(self, predicts, labels, scope=<span class="string">'loss_layer'</span>)</span>:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">#label为（(45,7,7,25)）  5个为盒子信息  (x,y,w,h,c)  后20个为类别</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            <span class="comment"># 预测值</span></span><br><span class="line">            <span class="comment"># class-20</span></span><br><span class="line">            predict_classes = tf.reshape(</span><br><span class="line">                predicts[:, :<span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">20</span>])</span><br><span class="line">            <span class="comment"># confidence-2</span></span><br><span class="line">            predict_confidence = tf.reshape(</span><br><span class="line">                predicts[:, <span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span>:<span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span> + <span class="number">7</span> * <span class="number">7</span> * <span class="number">2</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">2</span>])</span><br><span class="line">            <span class="comment"># bounding box-2*4</span></span><br><span class="line">            predict_boxes = tf.reshape(</span><br><span class="line">                predicts[:, <span class="number">7</span> * <span class="number">7</span> * <span class="number">20</span> + <span class="number">7</span> * <span class="number">7</span> * <span class="number">2</span>:],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 实际值</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,1)</span></span><br><span class="line">            <span class="comment"># response中的值为0或者1.对应的网格中存在目标为1，不存在目标为0.</span></span><br><span class="line">            <span class="comment"># 存在目标指的是存在目标的中心点，并不是说存在目标的一部分。所以，目标的中心点所在的cell其对应的值才为1，其余的值均为0</span></span><br><span class="line">            response = tf.reshape(</span><br><span class="line">                labels[..., <span class="number">0</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>])</span><br><span class="line">            <span class="comment"># shape(45,7,7,1,4)</span></span><br><span class="line">            boxes = tf.reshape(</span><br><span class="line">                labels[..., <span class="number">1</span>:<span class="number">5</span>],</span><br><span class="line">                [self.batch_size, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">4</span>])</span><br><span class="line">            <span class="comment"># shape(45,7,7,2,4),boxes的四个值，取值范围为0~1</span></span><br><span class="line">            boxes = tf.tile(</span><br><span class="line">                boxes, [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]) / self.img_shape[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># shape(45,7,7,20)</span></span><br><span class="line">            classes = labels[..., <span class="number">5</span>:]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># self.offset shape(7,7,2)</span></span><br><span class="line">            <span class="comment"># offset shape(1,7,7,2)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># shape(45,7,7,2)</span></span><br><span class="line">            x_offset = tf.tile(self.x_offset, [self.batch_size, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>])  <span class="comment">#(45,7,7,2)</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,2)</span></span><br><span class="line">            y_offset = tf.transpose(x_offset, (<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># convert the x, y to the coordinates relative to the top left point of the image</span></span><br><span class="line">            <span class="comment"># the predictions of w, h are the square root</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,2,4)  -&gt;(x,y,w,h)</span></span><br><span class="line">            predict_boxes_tran = tf.stack(</span><br><span class="line">                [(predict_boxes[..., <span class="number">0</span>] + x_offset) / <span class="number">7</span>,</span><br><span class="line">                 (predict_boxes[..., <span class="number">1</span>] + y_offset) / <span class="number">7</span>,</span><br><span class="line">                 tf.square(predict_boxes[..., <span class="number">2</span>]),</span><br><span class="line">                 tf.square(predict_boxes[..., <span class="number">3</span>])], axis=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 预测box与真实box的IOU,shape(45,7,7,2)</span></span><br><span class="line">            iou_predict_truth = self.calc_iou(predict_boxes_tran, boxes)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate I tensor [BATCH_SIZE, CELL_SIZE, CELL_SIZE, BOXES_PER_CELL]</span></span><br><span class="line">            <span class="comment"># shape(45,7,7,1), find the maximum iou_predict_truth in every cell</span></span><br><span class="line">            <span class="comment"># 在训练时，如果该单元格内确实存在目标，那么只选择IOU最大的那个边界框来负责预测该目标，而其它边界框认为不存在目标</span></span><br><span class="line">            object_mask = tf.reduce_max(iou_predict_truth, <span class="number">3</span>, keep_dims=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># object probs (45,7,7,2)</span></span><br><span class="line">            object_mask = tf.cast(</span><br><span class="line">                (iou_predict_truth &gt;= object_mask), tf.float32) * response</span><br><span class="line"></span><br><span class="line">            <span class="comment"># calculate no_I tensor [CELL_SIZE, CELL_SIZE, BOXES_PER_CELL]</span></span><br><span class="line">            <span class="comment"># noobject confidence(45,7,7,2)</span></span><br><span class="line">            noobject_probs = tf.ones_like(</span><br><span class="line">                object_mask, dtype=tf.float32) - object_mask</span><br><span class="line"></span><br><span class="line">            <span class="comment"># shape(45,7,7,2,4)，对boxes的四个值进行规整，xy为相对于网格左上角，wh为取根号后的值，范围0~1</span></span><br><span class="line">            boxes_tran = tf.stack(</span><br><span class="line">                [boxes[..., <span class="number">0</span>] * <span class="number">7</span> - x_offset,</span><br><span class="line">                 boxes[..., <span class="number">1</span>] * <span class="number">7</span> - y_offset,</span><br><span class="line">                 tf.sqrt(boxes[..., <span class="number">2</span>]),</span><br><span class="line">                 tf.sqrt(boxes[..., <span class="number">3</span>])], axis=<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># class_loss shape(45,7,7,20)</span></span><br><span class="line">            class_delta = response * (predict_classes - classes)</span><br><span class="line">            class_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(class_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'class_loss'</span>) * self.class_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># object_loss  confidence=iou*p(object)</span></span><br><span class="line">            <span class="comment"># p(object)的值为1或0</span></span><br><span class="line">            object_delta = object_mask * (predict_confidence - iou_predict_truth)</span><br><span class="line">            object_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(object_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'object_loss'</span>) * self.object_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># noobject_loss  p(object)的值为0</span></span><br><span class="line">            noobject_delta = noobject_probs * predict_confidence</span><br><span class="line">            noobject_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(noobject_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">                name=<span class="string">'noobject_loss'</span>) * self.noobject_scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># coord_loss</span></span><br><span class="line">            coord_mask = tf.expand_dims(object_mask, <span class="number">4</span>)</span><br><span class="line">            boxes_delta = coord_mask * (predict_boxes - boxes_tran)</span><br><span class="line">            coord_loss = tf.reduce_mean(</span><br><span class="line">                tf.reduce_sum(tf.square(boxes_delta), axis=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]),</span><br><span class="line">                name=<span class="string">'coord_loss'</span>) * self.coord_scale</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> class_loss+object_loss+noobject_loss+coord_loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train_yolo</span><span class="params">(self)</span>:</span></span><br><span class="line">        global_step = tf.train.create_global_step()</span><br><span class="line">        learning_rate = tf.train.exponential_decay(</span><br><span class="line">            <span class="number">0.0001</span>, global_step, <span class="number">30000</span>,</span><br><span class="line">            <span class="number">0.1</span>, <span class="literal">True</span>, name=<span class="string">'learning_rate'</span>)</span><br><span class="line">        op = tf.train.GradientDescentOptimizer(learning_rate).minimize()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_detect_from_image</span><span class="params">(self, image)</span>:</span></span><br><span class="line"></span><br><span class="line">        img_resized = cv2.resize(image, (<span class="number">448</span>, <span class="number">448</span>))</span><br><span class="line">        self.img = img_resized</span><br><span class="line">        img_RGB = cv2.cvtColor(img_resized, cv2.COLOR_BGR2RGB)</span><br><span class="line">        img_RGB = np.expand_dims(img_RGB,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        img_resized_np = np.asarray(img_RGB)</span><br><span class="line">        _images = np.zeros((<span class="number">1</span>, <span class="number">448</span>, <span class="number">448</span>, <span class="number">3</span>), dtype=np.float32)</span><br><span class="line">        _images[<span class="number">0</span>] = (img_resized_np / <span class="number">255.0</span>) * <span class="number">2.0</span> - <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _images</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">draw_rectangle</span><span class="params">(self,j,img, classes, scores, bboxes, colors, thickness=<span class="number">2</span>)</span>:</span></span><br><span class="line">        f = open(<span class="string">'./output/final.txt'</span>, <span class="string">"a"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(bboxes.shape[<span class="number">0</span>]):</span><br><span class="line">            x = int(bboxes[i][<span class="number">0</span>])</span><br><span class="line">            y = int(bboxes[i][<span class="number">1</span>])</span><br><span class="line">            w = int(bboxes[i][<span class="number">2</span>]) // <span class="number">2</span></span><br><span class="line">            h = int(bboxes[i][<span class="number">3</span>]) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#print("[x, y, w, h]=[%d, %d, %d, %d]" % (x, y, w, h))</span></span><br><span class="line">            f.write(<span class="string">'[x, y, w, h]=['</span>+str(x)+<span class="string">','</span>+str(y)+<span class="string">','</span>+str(w)+<span class="string">','</span>+str(h)+<span class="string">']\n'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 中心坐标 + 宽高box(x, y, w, h) -&gt; xmin = x - w / 2 -&gt; 左上 + 右下box(xmin, ymin, xmax, ymax)</span></span><br><span class="line">            cv2.rectangle(img, (x - w, y - h), (x + w, y + h), colors[<span class="number">0</span>], thickness)</span><br><span class="line">            <span class="comment"># 在边界框上显示类别、分数(类别置信度)</span></span><br><span class="line">            s = <span class="string">'%s/%.3f'</span> % (self.classes[classes[i]], scores[i])</span><br><span class="line">            cv2.rectangle(img, (x - w, y - h - <span class="number">20</span>), (x + w, y - h), (<span class="number">125</span>, <span class="number">125</span>, <span class="number">125</span>), <span class="number">-1</span>)</span><br><span class="line">            cv2.putText(img, s, (x - w + <span class="number">5</span>, y - h - <span class="number">7</span>),</span><br><span class="line">                        cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.5</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">1</span>)</span><br><span class="line">        <span class="comment">#cv2.namedWindow("img", 0)</span></span><br><span class="line">        cv2.resizeWindow(<span class="string">"img"</span>, <span class="number">640</span>, <span class="number">480</span>)</span><br><span class="line">        <span class="comment">#cv2.imshow('img', img)</span></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">        <span class="comment">#将处理后的每帧图片存到本地</span></span><br><span class="line">        address = <span class="string">'./output/'</span> + str(j)+ <span class="string">'.jpg'</span></span><br><span class="line">        cv2.imwrite(address,img)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#将位置信息写入文件</span></span><br><span class="line">        f.write(<span class="string">'\n'</span>)</span><br><span class="line">        </span><br><span class="line">      </span><br><span class="line">        <span class="comment">#cv2.waitKey(1)    #一般里面都填0，表示等待鼠标关闭。填其他数字表示每隔多少毫秒听力有一次画面</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#实例化yolo对象</span></span><br><span class="line">    yo = Yolo()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#搭建网络模型(预测):模型的主体网络部分，这个网络将输出[batch,7*7*30]的张量</span></span><br><span class="line">    pred,x = yo._build_net()  </span><br><span class="line">    _scores, _boxes, _box_classes = yo.filter(pred)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#  导入权重文件</span></span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess = tf.Session()</span><br><span class="line">    checkpoint_path = <span class="string">'./model/v1/YOLO_small.ckpt'</span></span><br><span class="line">    saver = tf.train.Saver()</span><br><span class="line">    sess.run(init)</span><br><span class="line">    saver.restore(sess, checkpoint_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取视频文件</span></span><br><span class="line">    cap = cv2.VideoCapture(<span class="string">"./test/3.mp4"</span>)</span><br><span class="line">    <span class="comment"># 通过摄像头的方式</span></span><br><span class="line">    <span class="comment"># videoCapture=cv2.VideoCapture(1)</span></span><br><span class="line">    <span class="comment">#读帧</span></span><br><span class="line">    j=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> cap.isOpened():</span><br><span class="line">        ret, frame = cap.read()</span><br><span class="line">        img = yo._detect_from_image(frame)</span><br><span class="line">        </span><br><span class="line">        scores, boxes, box_classes = sess.run([_scores, _boxes, _box_classes],feed_dict={x:img})</span><br><span class="line">        <span class="comment">#print(scores, box_classes)</span></span><br><span class="line">        yo.draw_rectangle(j,yo.img,box_classes,scores,boxes,[[<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>],[<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>]])</span><br><span class="line">        j=j+<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>
<p><font color="red">运行结果（第30帧）：</font></p>
<p>由于上传视频太过缓慢，在这里只展示其中某一帧的检测结果。</p>
<img src= "/img/loading.gif" data-src="https://s1.ax1x.com/2020/07/11/U1Z639.jpg" alt="图15：视频检测结果（单帧）" style="zoom: 80%;">
<p>从图15可以看出，对于距离比较近的物体（车辆和人），还是有不错的检测效果，但对于较远处的，还是有些困难。</p>
<div class="note success">
            <p>原视频 。见：<a href="https://wwa.lanzous.com/ivijLej0vmb" target="_blank" rel="noopener external nofollow noreferrer">传送门</a></p><p>处理后的视频。见：<a href="https://wwa.lanzous.com/iRJ1sej0vji" target="_blank" rel="noopener external nofollow noreferrer">传送门</a></p><p>另外，检测到的bbox位置也特别多，无法截图展示，我就把信息全部写入到了txt文本中。见：<a href="https://cdn.jsdelivr.net/gh/han-suyu/img_cdn/final_v1.txt" target="_blank" rel="noopener external nofollow noreferrer">传送门</a></p>
          </div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<blockquote>
<p><strong>参考：</strong><br>
本文图片很多来自PPT: <a href="https://docs.google.com/presentation/d/1aeRvtKG21KHdD5lg6Hgyhx5rPq_ZOsGjG5rJ1HP7BbA/pub?start=false&amp;loop=false&amp;delayms=3000&amp;slide=id.p" target="_blank" rel="noopener external nofollow noreferrer">deepsystems.io</a><br>
<a href="https://zhuanlan.zhihu.com/p/37850811" target="_blank" rel="noopener external nofollow noreferrer">https://zhuanlan.zhihu.com/p/37850811</a><br>
<a href="https://zhuanlan.zhihu.com/p/25236464" target="_blank" rel="noopener external nofollow noreferrer">https://zhuanlan.zhihu.com/p/25236464</a><br>
<a href="https://www.shuzhiduo.com/A/1O5EYWn757/" target="_blank" rel="noopener external nofollow noreferrer">https://www.shuzhiduo.com/A/1O5EYWn757/</a><br>
<a href="https://xmfbit.github.io/2017/02/04/yolo-paper/" target="_blank" rel="noopener external nofollow noreferrer">https://xmfbit.github.io/2017/02/04/yolo-paper/</a><br>
<a href="https://www.jianshu.com/p/d147b94df939" target="_blank" rel="noopener external nofollow noreferrer">https://www.jianshu.com/p/d147b94df939</a><br>
<a href="https://zhuanlan.zhihu.com/p/25045711" target="_blank" rel="noopener external nofollow noreferrer">https://zhuanlan.zhihu.com/p/25045711</a></p>
</blockquote>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Seven</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://hansuyu.com/2020/07/3774741536.html">http://hansuyu.com/2020/07/3774741536.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hansuyu.com" target="_blank">愿风载尘</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/">目标检测</a><a class="post-meta__tags" href="/tags/YOLO/">YOLO</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/han-suyu/cover/21.jpg" data-sites="wechat,weibo,qq,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信" onclick="window.open('/img/wechat.jpg')"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="支付宝" onclick="window.open('/img/wechat.jpg')"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/07/1563922670.html"><img class="prev-cover" data-src="https://cdn.jsdelivr.net/gh/han-suyu/cover/21.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">YOLO v2学习总结</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/1919729354.html"><img class="next-cover" data-src="https://cdn.jsdelivr.net/gh/han-suyu/cover/2.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">基于DenseNet模型实现MNIST手写体数据集的训练</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var requestSetting = function (from,set) {
  var from = from
  var setting = set.split(',').filter(function(item){
  return from.indexOf(item) > -1
  });
  setting = setting.length == 0 ? from :setting;
  return setting
}

var guestInfo = requestSetting(['nick','mail','link'],'nick,mail')
var requiredFields = requestSetting(['nick','mail'],'nick,mail')

window.valine = new Valine({
  el:'#vcomment',
  appId: 'a9HNNTF9yMcoVFJrKlLyoaAY-gzGzoHsz',
  appKey: 'utzaiW0SY0JMcLNyWSQUhU0o',
  placeholder: '使用QQ号作为昵称会自动加载你的邮箱与头像哦~',
  avatar: 'wavatar',
  meta: guestInfo,
  pageSize: '10',
  lang: 'zh-CN',
  recordIP: true,
  serverURLs: '',
  emojiCDN: '',
  emojiMaps: "",
  enableQQ: true,
  requiredFields: requiredFields
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Seven</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener external nofollow noreferrer"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener external nofollow noreferrer"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">简</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener external nofollow noreferrer" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>$(function () {
  $('span.katex-display').wrap('<div class="katex-wrap"></div>')
})</script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
  pangu.autoSpacingPage()
})</script><script src="/js/search/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script></body></html>